rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get user role from custom claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is teacher (admin)
    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'teacher';
    }

    // Helper function to check if user is tutor
    function isTutor() {
      return isAuthenticated() && getUserRole() == 'tutor';
    }

    // Helper function to check if user is student
    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }

    // Helper to check if user's email is in students array
    // Note: This is simplified - checks if email is directly in array
    // In practice, we check in the application layer before writing
    function isStudentInList(students) {
      return request.auth.uid in students;
    }

    // Users collection - only teachers can modify roles
    match /users/{email} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == email;
      allow update: if isTeacher() || (isAuthenticated() && request.auth.uid == email && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
      allow delete: if isTeacher();
    }

    // Events collection (APPROVED events only - counts for payroll/hours)
    match /events/{eventId} {
      allow read: if isAuthenticated();

      // Only teachers can create/update/delete events
      allow create, update, delete: if isTeacher();
    }

    // Email Events Queue collection (temporary queue for email notifications)
    match /emailEventsQueue/{eventId} {
      allow read: if isAuthenticated();

      // Only teachers can manage email queue
      allow create, update, delete: if isTeacher();
    }

    // Student Event Requests collection (displays on calendar in red, no payroll impact)
    match /studentEventRequests/{requestId} {
      allow read: if isAuthenticated();

      // Only students can create their own requests
      allow create: if isStudent();

      // Teachers can update/delete any request, students can update/delete their own requests
      allow update, delete: if isTeacher()
        || (isStudent() && isStudentInList(resource.data.students));
    }

    // Tutor Availabilities collection (tutor availability slots)
    match /tutorAvailabilities/{availabilityId} {
      allow read: if isAuthenticated();

      // Only tutors can create their own availabilities
      allow create: if isTutor() && request.auth.uid == request.resource.data.tutor;

      // Tutors can update/delete their own availabilities, teachers can manage all
      allow update, delete: if isTeacher() || (isTutor() && request.auth.uid == resource.data.tutor);
    }

    // Classes collection - only teachers can modify
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }

    // Subjects collection - only teachers can modify
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }

    // Students collection - read access for authenticated users
    match /students/{studentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }
  }
}
